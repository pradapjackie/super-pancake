name: ğŸš€ Manual Publish Package

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version increment type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
      force_publish:
        description: 'Force publish even if version unchanged'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  verify-tests:
    name: ğŸ§ª Verify Tests Before Publish
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        
    - name: ğŸ“¦ Install dependencies
      run: npm install
      
    - name: ğŸ§ª Run comprehensive test suite
      run: npm run test:all-no-server
      env:
        NODE_ENV: production
        CI: true
        
    - name: ğŸ“Š Generate final test report
      run: npm run test:report
      
    - name: ğŸ“‹ Upload pre-publish test results
      uses: actions/upload-artifact@v4
      with:
        name: pre-publish-test-results
        path: |
          test-report.html
          TEST_REPORT.md
        retention-days: 90

  bump-version:
    name: ğŸ·ï¸ Bump Version
    runs-on: ubuntu-latest
    needs: verify-tests
    outputs:
      new-version: ${{ steps.bump.outputs.new-version }}
      old-version: ${{ steps.bump.outputs.old-version }}
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        
    - name: ğŸ”§ Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: ğŸ·ï¸ Bump version
      id: bump
      run: |
        OLD_VERSION=$(node -p "require('./package.json').version")
        NEW_VERSION=$(npm version ${{ github.event.inputs.version_type }} --no-git-tag-version)
        
        # Update create-super-pancake version to match
        cd create-super-pancake
        npm version $NEW_VERSION --no-git-tag-version
        cd ..
        
        echo "old-version=$OLD_VERSION" >> $GITHUB_OUTPUT
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        echo "ğŸ“‹ Bumped version from $OLD_VERSION to $NEW_VERSION"
        echo "ğŸ“‹ Updated create-super-pancake to $NEW_VERSION"
        
    - name: ğŸ’¾ Commit version bump
      run: |
        git add package.json create-super-pancake/package.json
        git commit -m "chore: bump version to ${{ steps.bump.outputs.new-version }} [skip ci]"
        git tag ${{ steps.bump.outputs.new-version }}
        git push origin HEAD --tags
        git push origin HEAD

  publish:
    name: ğŸš€ Publish to NPM
    runs-on: ubuntu-latest
    needs: [verify-tests, bump-version]
    environment: 
      name: production
      
    steps:
    - name: ğŸ“¥ Checkout repository with latest changes
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
        ref: main
        
    - name: ğŸ”„ Pull latest changes
      run: git pull origin main
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        registry-url: 'https://registry.npmjs.org'
        
    - name: ğŸ“¦ Install dependencies
      run: npm install
      
    - name: ğŸ§ª Final test run
      run: npm run test:all-no-server
      env:
        NODE_ENV: production
        CI: true
        
    - name: ğŸ” Verify package contents
      run: |
        echo "ğŸ“‹ Main package contents:"
        npm pack --dry-run
        echo "ğŸ“‹ Create package contents:"
        cd create-super-pancake && npm pack --dry-run && cd ..
        
    - name: ğŸš€ Publish create-super-pancake
      run: |
        cd create-super-pancake
        echo "ğŸš€ Publishing create-super-pancake@${{ needs.bump-version.outputs.new-version }}..."
        npm publish --access public
        cd ..
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        
    - name: ğŸš€ Publish main package
      run: |
        echo "ğŸš€ Publishing super-pancake-automation@${{ needs.bump-version.outputs.new-version }}..."
        npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  create-release:
    name: ğŸ·ï¸ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [verify-tests, bump-version, publish]
    if: needs.publish.result == 'success'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Download test report
      uses: actions/download-artifact@v4
      with:
        name: pre-publish-test-results
        
    - name: ğŸ·ï¸ Create release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.bump-version.outputs.new-version }}
        name: "ğŸ¥ ${{ needs.bump-version.outputs.new-version }}"
        body: |
          ## ğŸš€ Super Pancake Framework ${{ needs.bump-version.outputs.new-version }}

          **Previous version:** ${{ needs.bump-version.outputs.old-version }}
          **Version type:** ${{ github.event.inputs.version_type }}

          ### Release Notes
          ${{ github.event.inputs.release_notes }}

          This release has been manually published after comprehensive testing.

          ### âœ… Test Coverage Summary
          - ğŸ§ª 156 individual tests across 8 test suites
          - ğŸ”’ Security validation and input sanitization  
          - âš¡ Performance and caching optimizations
          - ğŸ›ï¸ Configuration management
          - ğŸ“Š HTML test reporting
          - ğŸŒ Cross-platform compatibility (Node.js 18.x, 20.x)

          ### ğŸ“¦ Installation
          ```bash
          npm install super-pancake-automation-framework
          ```

          ### ğŸ”— Links
          - ğŸ“‹ [Test Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - ğŸ“š [Documentation](https://github.com/${{ github.repository }}#readme)
          - ğŸ› [Report Issues](https://github.com/${{ github.repository }}/issues)

          ---
          *This release was automatically created by GitHub Actions after all tests passed.*
        draft: false
        prerelease: false

  notify-success:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: [verify-tests, bump-version, publish, create-release]
    if: always() && needs.publish.result == 'success'
    
    steps:
    - name: ğŸ‰ Success notification
      run: |
        echo "ğŸ‰ Successfully published Super Pancake Framework!"
        echo "ğŸ“¦ Version: ${{ needs.bump-version.outputs.new-version }}"
        echo "ğŸ”— NPM: https://www.npmjs.com/package/super-pancake-automation-framework"
        echo "ğŸ·ï¸ Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.bump-version.outputs.new-version }}"
